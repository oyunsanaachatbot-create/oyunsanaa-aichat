// app/(chat)/mind/balance/test/score.ts

export type BalanceNarrative = {
  headline: string;        // Том гарчиг
  summary: string;         // 2-3 өгүүлбэрийн гол утга
  meaning: string;         // Оноо юу илэрхийлж байна
  focus: string;           // Анхаарах 1-2 чиглэлээ ямар байдлаар ойлгох
  strength: string;        // Давуу талын тайлбар
};

function clamp(n: number, min: number, max: number) {
  return Math.max(min, Math.min(max, n));
}

function band(score100: number) {
  const s = clamp(score100, 0, 100);
  if (s < 35) return "low";
  if (s < 55) return "mid";
  if (s < 75) return "good";
  return "strong";
}

/** deterministic pick: seed дээр тулгуурлаад нэг л хувилбарыг сонгоно */
function mulberry32(seed: number) {
  return function () {
    let t = (seed += 0x6d2b79f5);
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}
function pick<T>(seed: number, items: T[]): T {
  const r = mulberry32(seed)();
  return items[Math.floor(r * items.length)] ?? items[0];
}

/**
 * ✅ Амьд, “зөвлөгөөгүй” дүгнэлт
 * - totalScore100 + weakest + strongest дээр тулгуурлана
 * - 8–12 төрлийн хувилбар
 */
export function buildNarrative(opts: {
  totalScore100: number;
  weakestLabels: string[];   // 1-2 чиглэлийн label
  strongestLabel?: string;   // 1 чиглэлийн label
  seed: number;              // run.at зэрэг тогтвортой seed өг
}): BalanceNarrative {
  const { totalScore100, weakestLabels, strongestLabel, seed } = opts;
  const b = band(totalScore100);

  const headline = pick(seed, [
    "Таны өнөөдрийн зураглал",
    "Одоогийн тэнцвэрийн дүр зураг",
    "Өнөөдрийн байдал ямар харагдаж байна вэ?",
    "Сэтгэлийн тэнцвэрийн тойм",
    "Таны одоогийн чиг баримжаа",
    "Өнөөдрийн ерөнхий зураг",
    "Тэнцвэрийн товч тайлан",
    "Таны одоогийн хэмнэл",
    "Одоогийн төлөвийн зураг",
    "Таны өнөөдрийн дүгнэлт",
    "Өнөөдрийн дотоод зураглал",
    "Одоогийн байдал: тойм",
  ]);

  const scoreMeaningByBand: Record<string, string[]> = {
    low: [
      "Оноо бага байна гэдэг нь “муу” гэсэн шүүлт биш. Харин сүүлийн үед дэмжлэг, тогтвортой байдал, энерги 2–3 чиглэл дээр зэрэг сулрах хандлагатайг л илтгэнэ.",
      "Энэ түвшин ихэнхдээ олон зүйл давхцсан үед гардаг. Чи сул хүн гэсэн үг биш — харин систем/орчин/дотоод нөөц зэрэг нь зэрэг ачаалал авч байгааг харуулж байна.",
      "Одоогийн оноо бол нэг өдрийн бодит зураглал. Зарим үед хүний дотоод тэнцвэр “тасархай” мэт мэдрэгддэг бөгөөд энэ нь хэвийн үзэгдэл байж болно.",
    ],
    mid: [
      "Оноо дунд түвшинд байна. Энэ нь “зарим талдаа боломжийн, зарим талдаа савлагаатай” гэсэн зураглал.",
      "Дунд оноо нь хоёр өөр ертөнц зэрэгцэж байгааг хэлдэг: нэг талдаа дажгүй ажиллаж буй зүйлс, нөгөө талдаа тогтворгүй мэдрэмж өгөх хэсгүүд.",
      "Энэ түвшин бол олон хүний хамгийн нийтлэг төлөв. Сайн талууд чинь байгаа, гэхдээ тогтвортой байдал тийм ч жигд биш байна.",
    ],
    good: [
      "Оноо сайн түвшинд байна. Ерөнхий суурь боломжийн, өдөр тутмын савлагаа ихэвчлэн удирдаж болох хэмжээнд байна.",
      "Сайн түвшин гэдэг нь тогтвортой зуршлуудын нөлөө мэдэгдэж эхэлснийг илтгэнэ. Зарим чиглэлд бага зэрэг хэлбэлзэл хэвээр байж болно.",
      "Энэ зураглалд таны ерөнхий хэмнэл боломжийн байна — дотоод нөөц тань ажиллаж байна гэсэн үг.",
    ],
    strong: [
      "Оноо өндөр байна. Ерөнхий тэнцвэр тогтвортой, дотоод нөөц болон орчны дэмжлэг харьцангуй сайн ажиллаж байна.",
      "Өндөр оноо нь “бүгд төгс” гэсэн үг биш ч таны суурь тогтвортой байгааг хэлдэг.",
      "Энэ түвшин бол тогтвортой суурь байна гэсэн дохио. Ховор сулрах цэг байж болох ч нийт зураг сайн байна.",
    ],
  };

  const meaning = pick(seed + 1, scoreMeaningByBand[b]);

  const w1 = weakestLabels[0] ?? "—";
  const w2 = weakestLabels[1] ?? "";
  const weakestLine = w2 ? `${w1} ба ${w2}` : w1;

  const focusVariants = [
    `Одоогийн зураглал дээр хамгийн “доош татсан” хэсгүүд бол ${weakestLine}. Энэ нь тухайн чиглэлүүд дээр тогтвортой байдал, итгэл, мэдрэмжийн хэлбэлзэл зэрэг илүү мэдрэгдэж болохыг харуулна.`,
    `${weakestLine} чиглэлүүдэд оноо харьцангуй доогуур байна. Энэ нь “чадахгүй” гэсэн үг биш — харин таны амьдралын энэ үед хамгийн их мэдрэгдэж буй хэсгүүд энд төвлөрч байгааг л хэлнэ.`,
    `Хамгийн эмзэг цэгүүд ${weakestLine} тал руу илүү байна. Ихэвчлэн энэ нь орчин, ачаалал, харилцаа, дотоод хүлээлт зэрэгтэй хамт хөдөлдөг.`,
    `Онооны хэлбэлзэл хамгийн ихээр ${weakestLine} дээр мэдрэгдэж байна. Энэ нь таны өдрүүдийн мэдрэмжийг хамгийн их өөрчилдөг талууд байж магадгүй.`,
  ];
  const focus = pick(seed + 2, focusVariants);

  const strengthVariants = strongestLabel
    ? [
        `Давуу тал: ${strongestLabel}. Энэ чиглэл чинь одоогоор “суурь” мэт ажиллаж байна — өдөр тутмын бусад хэсэг савлах үед ч дотоод тулгуур болж өгдөг.`,
        `Харьцангуй тогтвортой харагдсан хэсэг: ${strongestLabel}. Энэ нь таны системд ажиллаж байгаа зүйлс байна гэсэн дохио.`,
        `Сайн ажиллаж буй чиглэл: ${strongestLabel}. Ийм “баттай” хэсэг байхад бусад талууд аажмаар тэнцвэржинэ.`,
      ]
    : [
        "Давуу талын чиглэл тодорхой харагдахгүй байна. Энэ нь ихэвчлэн бүх чиглэл ойролцоо хэлбэлзэж байгаатай холбоотой байж болно.",
      ];
  const strength = pick(seed + 3, strengthVariants);

  const summaryVariants = [
    `Нийт оноо ${totalScore100}/100. Энэ бол өнөөдрийн бодит зураглал — таны дотоод тэнцвэр ямар хэмнэлтэй байгааг л харуулж байна.`,
    `Таны оноо ${totalScore100}/100. Энэ нь “шүүлт” биш, харин одоогийн төлөвийн хэмжүүр.`,
    `Өнөөдрийн зураглал: ${totalScore100}/100. Зарим чиглэл тогтвортой, зарим нь илүү мэдрэгдэж байна.`,
    `Оноо ${totalScore100}/100 байна. Энэ нь таны өнөөдрийн дотоод хэмнэл ямар байгааг харуулна.`,
  ];
  const summary = pick(seed + 4, summaryVariants);

  return { headline, summary, meaning, focus, strength };
}

/**
 * ✅ Зөвлөгөөгүй домайн тайлбар (таны хүссэн “амьд” тайлбар)
 */
export function domainNarrative(domainLabel: string, score100: number) {
  const s = clamp(score100, 0, 100);

  if (s >= 80) {
    return `${domainLabel} чиглэл дээр таны систем одоогоор тогтвортой харагдаж байна. Энэ нь тухайн тал дээр дотоод нөөц, орчны дэмжлэг, дадал зуршил харьцангуй жигд ажиллаж буйн дохио.`;
  }
  if (s >= 60) {
    return `${domainLabel} боломжийн түвшинд байна. Ерөнхийдөө “боломжийн” боловч зарим өдөр нөхцөл байдал, ачааллаас шалтгаалж хэлбэлзэл мэдрэгдэх магадлалтай зураглал.`;
  }
  if (s >= 40) {
    return `${domainLabel} дээр тогтвортой байдал жигд биш байна. Ихэвчлэн энэ нь дотоод хүлээлт, өдөр тутмын дарамт, орчны тогтворгүй байдалтай хамт мэдрэгддэг хэсэг байдаг.`;
  }
  return `${domainLabel} чиглэл одоогоор хамгийн эмзэг тал руу орж байна. Энэ нь “чадахгүй” гэсэн үг биш — харин таны амьдралын энэ үед хамгийн их мэдрэгдэж буй ачаалал/дутагдал энэ тал дээр төвлөрч байгааг харуулна.`;
}
